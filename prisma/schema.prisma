// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  //url      = env("DATABASE_URL")
}

enum Permessi{
  NIENTE
  SOLO_LETTURA
  ADMIN
}

model Utente {
  id_utente           String @id @default(uuid()) @db.Uuid
  email               String @unique
  password_cifrata    String
  nome                String
  cognome             String
  data_nascita        DateTime
  account_attivo      Boolean
  permessi_armadietto Permessi
  permessi_piano      Permessi

  notifiche Sottoscrizione_web_push[]
  allergie Allergia_utente[]
  caregiver Relazione[] @relation("Caregiver")
  assistito Relazione[] @relation("Assistito")
  armadietto Farmaco_armadietto[]
  armadietto_disuso Farmaco_armadietto_disuso[]
  terapie Piano_terapeutico[]

  @@map("utente")
}

model Farmaci {
  codice_aic          String @unique
  codice_atc          String?
  denominazione       String
  descrizione         String @db.Text 
  codice_ditta        Int?
  ragione_sociale     String
  forma               String
  principio_attivo    String
  dosaggio            String?
  confezione          String?
  quantita_confezione Float?
  unita_misura        String?
  json_dati_grezzi    Json?   

  armadietto Farmaco_armadietto[]

  @@map("farmaci")
}

model Sottoscrizione_web_push {
  id_sottoscrizione         String @id @default(uuid()) @db.Uuid
  id_utente                 String @db.Uuid
  endpoint_browser          String
  chiavi_cifratura_json     Json
  user_agent                String
  data_creazione            DateTime

  utente Utente @relation(fields: [id_utente], references: [id_utente])

  @@map("sottoscrizione_web_push")
}

model Allergia_utente{
  id_allergia           String @id @default(uuid()) @db.Uuid
  id_utente             String @db.Uuid
  id_allergene          String @db.Uuid
  gravita_reazione      Int

  utente Utente @relation(fields: [id_utente], references: [id_utente])
  allergene Allergeni @relation(fields: [id_allergene], references: [id_allergene])

  @@map("allergia_utente")
}

model Allergeni{
  id_allergene          String @id @default(uuid()) @db.Uuid
  sostanza_allergene    String

  utente Allergia_utente[]

  @@map("allergeni")
}

model Relazione{
  id_relazione          String @id @default(uuid()) @db.Uuid
  id_caregiver          String @db.Uuid
  id_assistito          String @db.Uuid
  permessi_armadietto   Permessi
  permessi_piano        Permessi

  caregiver Utente @relation("Caregiver", fields: [id_caregiver], references: [id_utente])
  assistito Utente @relation("Assistito", fields: [id_assistito], references: [id_utente])

  @@map("relazione")
}

model Farmaco_armadietto{
  id_farmaco_armadietto       String @id @default(uuid()) @db.Uuid
  id_utente_proprietario      String @db.Uuid
  codice_aic                  String
  data_scadenza               DateTime
  lotto_produzione            String?
  quantita_rimanente          Float

  utente Utente @relation(fields: [id_utente_proprietario], references: [id_utente])
  farmaco Farmaci @relation(fields: [codice_aic], references: [codice_aic])

  terapia Piano_terapeutico[]

  @@map("farmaco_armadietto")
}

model Farmaco_armadietto_disuso{
  id_storico                  String @id @default(uuid()) @db.Uuid
  id_utente_proprietario      String @db.Uuid
  codice_aic                  String
  data_scadenza               DateTime
  lotto_produzione            String?
  quantita_rimanente          Float

  utente Utente @relation(fields: [id_utente_proprietario], references: [id_utente])

  @@map("farmaco_armadietto_disuso")
}

model Piano_terapeutico{
  id_terapia                  String @id @default(uuid()) @db.Uuid
  id_paziente                 String @db.Uuid
  id_farmaco_armadietto       String @db.Uuid
  nome_utilita                String
  dose_singola                Float
  solo_al_bisogno             Boolean
  terapia_attiva              Boolean
  for_life                    Boolean

  paziente Utente @relation(fields: [id_paziente], references: [id_utente])
  farmaco Farmaco_armadietto @relation(fields: [id_farmaco_armadietto], references: [id_farmaco_armadietto])

  assunzioni Registro_assunzioni[]
  assunzioni_passate Registro_assunzioni_passate[]

  @@map("piano_terapeutico")
}

model Registro_assunzioni{
  id_evento                   String @id @default(uuid()) @db.Uuid
  id_terapia                  String @db.Uuid
  data_programmata            DateTime
  orario_effettivo            DateTime
  esito                       Boolean

  terapia Piano_terapeutico @relation(fields: [id_terapia], references: [id_terapia])

  @@map("registro_assunzioni")
}

model Registro_assunzioni_passate{
  id_storico                  String @id @default(uuid()) @db.Uuid
  id_terapia                  String @db.Uuid
  data_programmata            DateTime
  orario_effettivo            DateTime
  esito                       Boolean

  terapia Piano_terapeutico @relation(fields: [id_terapia], references: [id_terapia])

  @@map("registro_assunzioni_passate")
}